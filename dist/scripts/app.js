'use strict';

/**
 * File navigation.js.
 *
 * Handles toggling the navigation menu for small screens and enables TAB key
 * navigation support for dropdown menus.
 */
(function () {
	var container, button, menu, links, i, len, focusableElements, firstFocusableElement, lastFocusableElement;

	container = document.getElementById('js-menu--primary');

	// Bail if there is no menu.
	if (!container) {
		return;
	}

	button = container.getElementsByTagName('button')[0];
	if ('undefined' === typeof button) {
		return;
	}

	menu = container.getElementsByTagName('ul')[0];

	// Hide menu toggle button if menu is empty and return early.
	if ('undefined' === typeof menu) {
		button.style.display = 'none';
		return;
	}

	menu.setAttribute('aria-expanded', 'false');
	if (!menu.classList.contains('js-nav-menu')) {
		menu.classList.add('js-nav-menu');
	}

	button.addEventListener('click', function () {
		toggleMenu();

		setFocus();
	});

	// Close menu using Esc key.
	document.addEventListener('keyup', function (event) {
		if (27 === event.keyCode) {
			if (isMenuOpen()) {
				toggleMenu(); // Close menu.
				button.focus();
			}
		}
	});

	// Remove ARIA when on "desktop".
	window.addEventListener('resize', removeAria);

	// Get all the link elements within the menu.
	links = menu.getElementsByTagName('a');

	// Each time a menu link is focused or blurred, toggle focus.
	for (i = 0, len = links.length; i < len; i++) {
		links[i].addEventListener('focus', toggleFocus, true);
		links[i].addEventListener('blur', toggleFocus, true);
	}

	/**
  * Toggle menu classes and ARIA.
  */
	function toggleMenu() {
		container.classList.toggle('is-toggled');

		var expanded = 'false' === button.getAttribute('aria-expanded') ? 'true' : 'false';
		button.setAttribute('aria-expanded', expanded);
		menu.setAttribute('aria-expanded', expanded);
	}

	/**
  * Set focus when nav is open.
  */
	function setFocus() {

		// Bail if menu is not open.
		if (!isMenuOpen()) {
			return;
		}

		// Set focusable elements inside main navigation.
		focusableElements = container.querySelectorAll(['a[href]', 'area[href]', 'input:not([disabled])', 'select:not([disabled])', 'textarea:not([disabled])', 'button:not([disabled])', 'iframe', 'object', 'embed', '[contenteditable]', '[tabindex]:not([tabindex^="-"])']);
		firstFocusableElement = focusableElements[0];
		lastFocusableElement = focusableElements[focusableElements.length - 1];

		// Redirect last Tab to first focusable element.
		lastFocusableElement.addEventListener('keydown', function (e) {
			if (9 === e.keyCode && !e.shiftKey) {
				e.preventDefault();
				button.focus(); // Set focus on first element - that's actually close menu button.
			}
		});

		// Redirect first Shift+Tab to toggle button element.
		firstFocusableElement.addEventListener('keydown', function (e) {
			if (9 === e.keyCode && e.shiftKey) {
				e.preventDefault();
				button.focus(); // Set focus on first element.
			}
		});

		// Redirect Shift+Tab from the toggle button to last focusable element.
		button.addEventListener('keydown', function (e) {
			if (9 === e.keyCode && e.shiftKey) {
				e.preventDefault();
				lastFocusableElement.focus(); // Set focus on last element.
			}
		});
	}

	/**
  * Is menu open.
  *
  * @returns {boolean} True or false.
  */
	function isMenuOpen() {
		var isMenuOpen = 'false' === button.getAttribute('aria-expanded') ? false : true;
		return isMenuOpen;
	}

	/**
  * Remove ARIA on "desktop".
  */
	function removeAria() {

		// If menu toggle button have display: none css rule, we're on desktop.
		if ('none' === window.getComputedStyle(button, null).getPropertyValue('display')) {
			button.setAttribute('aria-expanded', 'false');
			menu.setAttribute('aria-expanded', 'false');
		}
	}

	/**
  * Sets or removes .focus class on an element.
  */
	function toggleFocus() {
		var self = this;

		// Move up through the ancestors of the current link until we hit .js-nav-menu.
		while (-1 === self.className.indexOf('js-nav-menu')) {

			// On li elements toggle the class .focus.
			if ('li' === self.tagName.toLowerCase()) {
				if (-1 !== self.className.indexOf('focus')) {
					self.className = self.className.replace(' focus', '');
				} else {
					self.className += ' focus';
				}
			}

			self = self.parentElement;
		}
	}

	/**
  * Toggles `focus` class to allow submenu access on tablets.
  */
	(function (container) {
		var touchStartFn,
		    i,
		    parentLink = container.querySelectorAll('.menu-item-has-children > a, .page_item_has_children > a');

		if ('ontouchstart' in window) {
			touchStartFn = function touchStartFn(e) {
				var menuItem = this.parentNode,
				    i;

				if (!menuItem.classList.contains('focus')) {
					e.preventDefault();
					for (i = 0; i < menuItem.parentNode.children.length; ++i) {
						if (menuItem === menuItem.parentNode.children[i]) {
							continue;
						}
						menuItem.parentNode.children[i].classList.remove('focus');
					}
					menuItem.classList.add('focus');
				} else {
					menuItem.classList.remove('focus');
				}
			};

			for (i = 0; i < parentLink.length; ++i) {
				parentLink[i].addEventListener('touchstart', touchStartFn, false);
			}
		}
	})(container);
})();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6WyJjb250YWluZXIiLCJidXR0b24iLCJtZW51IiwibGlua3MiLCJpIiwibGVuIiwiZm9jdXNhYmxlRWxlbWVudHMiLCJmaXJzdEZvY3VzYWJsZUVsZW1lbnQiLCJsYXN0Rm9jdXNhYmxlRWxlbWVudCIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsInN0eWxlIiwiZGlzcGxheSIsInNldEF0dHJpYnV0ZSIsImNsYXNzTGlzdCIsImNvbnRhaW5zIiwiYWRkIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRvZ2dsZU1lbnUiLCJzZXRGb2N1cyIsImV2ZW50Iiwia2V5Q29kZSIsImlzTWVudU9wZW4iLCJmb2N1cyIsIndpbmRvdyIsInJlbW92ZUFyaWEiLCJsZW5ndGgiLCJ0b2dnbGVGb2N1cyIsInRvZ2dsZSIsImV4cGFuZGVkIiwiZ2V0QXR0cmlidXRlIiwicXVlcnlTZWxlY3RvckFsbCIsImUiLCJzaGlmdEtleSIsInByZXZlbnREZWZhdWx0IiwiZ2V0Q29tcHV0ZWRTdHlsZSIsImdldFByb3BlcnR5VmFsdWUiLCJzZWxmIiwiY2xhc3NOYW1lIiwiaW5kZXhPZiIsInRhZ05hbWUiLCJ0b0xvd2VyQ2FzZSIsInJlcGxhY2UiLCJwYXJlbnRFbGVtZW50IiwidG91Y2hTdGFydEZuIiwicGFyZW50TGluayIsIm1lbnVJdGVtIiwicGFyZW50Tm9kZSIsImNoaWxkcmVuIiwicmVtb3ZlIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7QUFNRSxhQUFXO0FBQ1osS0FBSUEsU0FBSixFQUFlQyxNQUFmLEVBQXVCQyxJQUF2QixFQUE2QkMsS0FBN0IsRUFBb0NDLENBQXBDLEVBQXVDQyxHQUF2QyxFQUE0Q0MsaUJBQTVDLEVBQStEQyxxQkFBL0QsRUFBc0ZDLG9CQUF0Rjs7QUFFQVIsYUFBWVMsU0FBU0MsY0FBVCxDQUF5QixrQkFBekIsQ0FBWjs7QUFFQTtBQUNBLEtBQUssQ0FBRVYsU0FBUCxFQUFt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QSxRQUFNOUMsSUFBSSxDQUFWLEVBQWFBLElBQUkwQyxXQUFXbkIsTUFBNUIsRUFBb0MsRUFBRXZCLENBQXRDLEVBQTBDO0FBQ3pDMEMsZUFBVzFDLENBQVgsRUFBY2MsZ0JBQWQsQ0FBZ0MsWUFBaEMsRUFBOEMyQixZQUE5QyxFQUE0RCxLQUE1RDtBQUNBO0FBQ0Q7QUFDRCxFQTNCQyxFQTJCQzdDLFNBM0JELENBQUY7QUE0QkEsQ0F0TEMsR0FBRiIsImZpbGUiOiJhcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZpbGUgbmF2aWdhdGlvbi5qcy5cbiAqXG4gKiBIYW5kbGVzIHRvZ2dsaW5nIHRoZSBuYXZpZ2F0aW9uIG1lbnUgZm9yIHNtYWxsIHNjcmVlbnMgYW5kIGVuYWJsZXMgVEFCIGtleVxuICogbmF2aWdhdGlvbiBzdXBwb3J0IGZvciBkcm9wZG93biBtZW51cy5cbiAqL1xuKCBmdW5jdGlvbigpIHtcblx0dmFyIGNvbnRhaW5lciwgYnV0dG9uLCBtZW51LCBsaW5rcywgaSwgbGVuLCBmb2N1c2FibGVFbGVtZW50cywgZmlyc3RGb2N1c2FibGVFbGVtZW50LCBsYXN0Rm9jdXNhYmxlRWxlbWVudDtcblxuXHRjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggJ2pzLW1lbnUtLXByaW1hcnknICk7XG5cblx0Ly8gQmFpbCBpZiB0aGVyZSBpcyBubyBtZW51LlxuXHRpZiAoICEgY29udGFpbmVyICkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGJ1dHRvbiA9IGNvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSggJ2J1dHRvbicgKVswXTtcblx0aWYgKCAndW5kZWZpbmVkJyA9PT0gdHlwZW9mIGJ1dHRvbiApIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRtZW51ID0gY29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCAndWwnIClbMF07XG5cblx0Ly8gSGlkZSBtZW51IHRvZ2dsZSBidXR0b24gaWYgbWVudSBpcyBlbXB0eSBhbmQgcmV0dXJuIGVhcmx5LlxuXHRpZiAoICd1bmRlZmluZWQnID09PSB0eXBlb2YgbWVudSApIHtcblx0XHRidXR0b24uc3R5bGUuZGlzcGxheSA9ICdub25lJztcblx0XHRyZXR1cm47XG5cdH1cblxuXHRtZW51LnNldEF0dHJpYnV0ZSggJ2FyaWEtZXhwYW5kZWQnLCAnZmFsc2UnICk7XG5cdGlmICggISBtZW51LmNsYXNzTGlzdC5jb250YWlucyggJ2pzLW5hdi1tZW51JyApICkge1xuXHRcdG1lbnUuY2xhc3NMaXN0LmFkZCggJ2pzLW5hdi1tZW51JyApO1xuXHR9XG5cblx0YnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoICdjbGljaycsIGZ1bmN0aW9uKCkge1xuXHRcdHRvZ2dsZU1lbnUoKTtcblxuXHRcdHNldEZvY3VzKCk7XG5cdH0gKTtcblxuXHQvLyBDbG9zZSBtZW51IHVzaW5nIEVzYyBrZXkuXG5cdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdrZXl1cCcsIGZ1bmN0aW9uKCBldmVudCApIHtcblx0XHRpZiAoIDI3ID09PSBldmVudC5rZXlDb2RlICkge1xuXHRcdFx0aWYgKCBpc01lbnVPcGVuKCkgKSB7XG5cdFx0XHRcdHRvZ2dsZU1lbnUoKTsgLy8gQ2xvc2UgbWVudS5cblx0XHRcdFx0YnV0dG9uLmZvY3VzKCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9ICk7XG5cblx0Ly8gUmVtb3ZlIEFSSUEgd2hlbiBvbiBcImRlc2t0b3BcIi5cblx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdyZXNpemUnLCByZW1vdmVBcmlhICk7XG5cblx0Ly8gR2V0IGFsbCB0aGUgbGluayBlbGVtZW50cyB3aXRoaW4gdGhlIG1lbnUuXG5cdGxpbmtzID0gbWVudS5nZXRFbGVtZW50c0J5VGFnTmFtZSggJ2EnICk7XG5cblx0Ly8gRWFjaCB0aW1lIGEgbWVudSBsaW5rIGlzIGZvY3VzZWQgb3IgYmx1cnJlZCwgdG9nZ2xlIGZvY3VzLlxuXHRmb3IgKCBpID0gMCwgbGVuID0gbGlua3MubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7XG5cdFx0bGlua3NbaV0uYWRkRXZlbnRMaXN0ZW5lciggJ2ZvY3VzJywgdG9nZ2xlRm9jdXMsIHRydWUgKTtcblx0XHRsaW5rc1tpXS5hZGRFdmVudExpc3RlbmVyKCAnYmx1cicsIHRvZ2dsZUZvY3VzLCB0cnVlICk7XG5cdH1cblxuXHQvKipcblx0ICogVG9nZ2xlIG1lbnUgY2xhc3NlcyBhbmQgQVJJQS5cblx0ICovXG5cdGZ1bmN0aW9uIHRvZ2dsZU1lbnUoKSB7XG5cdFx0Y29udGFpbmVyLmNsYXNzTGlzdC50b2dnbGUoICdpcy10b2dnbGVkJyApO1xuXG5cdFx0bGV0IGV4cGFuZGVkID0gKCAnZmFsc2UnID09PSBidXR0b24uZ2V0QXR0cmlidXRlKCAnYXJpYS1leHBhbmRlZCcgKSApID8gJ3RydWUnIDogJ2ZhbHNlJztcblx0XHRidXR0b24uc2V0QXR0cmlidXRlKCAnYXJpYS1leHBhbmRlZCcsIGV4cGFuZGVkICk7XG5cdFx0bWVudS5zZXRBdHRyaWJ1dGUoICdhcmlhLWV4cGFuZGVkJywgZXhwYW5kZWQgKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXQgZm9jdXMgd2hlbiBuYXYgaXMgb3Blbi5cblx0ICovXG5cdGZ1bmN0aW9uIHNldEZvY3VzKCkge1xuXG5cdFx0Ly8gQmFpbCBpZiBtZW51IGlzIG5vdCBvcGVuLlxuXHRcdGlmICggISBpc01lbnVPcGVuKCkgKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Ly8gU2V0IGZvY3VzYWJsZSBlbGVtZW50cyBpbnNpZGUgbWFpbiBuYXZpZ2F0aW9uLlxuXHRcdGZvY3VzYWJsZUVsZW1lbnRzICAgICA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCBbICdhW2hyZWZdJywgJ2FyZWFbaHJlZl0nLCAnaW5wdXQ6bm90KFtkaXNhYmxlZF0pJywgJ3NlbGVjdDpub3QoW2Rpc2FibGVkXSknLCAndGV4dGFyZWE6bm90KFtkaXNhYmxlZF0pJywgJ2J1dHRvbjpub3QoW2Rpc2FibGVkXSknLCAnaWZyYW1lJywgJ29iamVjdCcsICdlbWJlZCcsICdbY29udGVudGVkaXRhYmxlXScsICdbdGFiaW5kZXhdOm5vdChbdGFiaW5kZXhePVwiLVwiXSknIF0gKTtcblx0XHRmaXJzdEZvY3VzYWJsZUVsZW1lbnQgPSBmb2N1c2FibGVFbGVtZW50c1swXTtcblx0XHRsYXN0Rm9jdXNhYmxlRWxlbWVudCAgPSBmb2N1c2FibGVFbGVtZW50c1tmb2N1c2FibGVFbGVtZW50cy5sZW5ndGggLSAxXTtcblxuXHRcdC8vIFJlZGlyZWN0IGxhc3QgVGFiIHRvIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50LlxuXHRcdGxhc3RGb2N1c2FibGVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdrZXlkb3duJywgZnVuY3Rpb24oIGUgKSB7XG5cdFx0XHRpZiAoICggOSA9PT0gZS5rZXlDb2RlICYmICEgZS5zaGlmdEtleSApICkge1xuXHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGJ1dHRvbi5mb2N1cygpOyAvLyBTZXQgZm9jdXMgb24gZmlyc3QgZWxlbWVudCAtIHRoYXQncyBhY3R1YWxseSBjbG9zZSBtZW51IGJ1dHRvbi5cblx0XHRcdH1cblx0XHR9ICk7XG5cblx0XHQvLyBSZWRpcmVjdCBmaXJzdCBTaGlmdCtUYWIgdG8gdG9nZ2xlIGJ1dHRvbiBlbGVtZW50LlxuXHRcdGZpcnN0Rm9jdXNhYmxlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAna2V5ZG93bicsIGZ1bmN0aW9uKCBlICkge1xuXHRcdFx0aWYgKCAoIDkgPT09IGUua2V5Q29kZSAmJiBlLnNoaWZ0S2V5ICkgKSB7XG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0YnV0dG9uLmZvY3VzKCk7IC8vIFNldCBmb2N1cyBvbiBmaXJzdCBlbGVtZW50LlxuXHRcdFx0fVxuXHRcdH0gKTtcblxuXHRcdC8vIFJlZGlyZWN0IFNoaWZ0K1RhYiBmcm9tIHRoZSB0b2dnbGUgYnV0dG9uIHRvIGxhc3QgZm9jdXNhYmxlIGVsZW1lbnQuXG5cdFx0YnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoICdrZXlkb3duJywgZnVuY3Rpb24oIGUgKSB7XG5cdFx0XHRpZiAoICggOSA9PT0gZS5rZXlDb2RlICYmIGUuc2hpZnRLZXkgKSApIHtcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRsYXN0Rm9jdXNhYmxlRWxlbWVudC5mb2N1cygpOyAvLyBTZXQgZm9jdXMgb24gbGFzdCBlbGVtZW50LlxuXHRcdFx0fVxuXHRcdH0gKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJcyBtZW51IG9wZW4uXG5cdCAqXG5cdCAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIG9yIGZhbHNlLlxuXHQgKi9cblx0ZnVuY3Rpb24gaXNNZW51T3BlbigpIHtcblx0XHRsZXQgaXNNZW51T3BlbiA9ICggJ2ZhbHNlJyA9PT0gYnV0dG9uLmdldEF0dHJpYnV0ZSggJ2FyaWEtZXhwYW5kZWQnICkgKSA/IGZhbHNlIDogdHJ1ZTtcblx0XHRyZXR1cm4gaXNNZW51T3Blbjtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZW1vdmUgQVJJQSBvbiBcImRlc2t0b3BcIi5cblx0ICovXG5cdGZ1bmN0aW9uIHJlbW92ZUFyaWEoKSB7XG5cblx0XHQvLyBJZiBtZW51IHRvZ2dsZSBidXR0b24gaGF2ZSBkaXNwbGF5OiBub25lIGNzcyBydWxlLCB3ZSdyZSBvbiBkZXNrdG9wLlxuXHRcdGlmICggJ25vbmUnID09PSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggYnV0dG9uLCBudWxsICkuZ2V0UHJvcGVydHlWYWx1ZSggJ2Rpc3BsYXknICkgKSB7XG5cdFx0XHRidXR0b24uc2V0QXR0cmlidXRlKCAnYXJpYS1leHBhbmRlZCcsICdmYWxzZScgKTtcblx0XHRcdG1lbnUuc2V0QXR0cmlidXRlKCAnYXJpYS1leHBhbmRlZCcsICdmYWxzZScgKTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogU2V0cyBvciByZW1vdmVzIC5mb2N1cyBjbGFzcyBvbiBhbiBlbGVtZW50LlxuXHQgKi9cblx0ZnVuY3Rpb24gdG9nZ2xlRm9jdXMoKSB7XG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0Ly8gTW92ZSB1cCB0aHJvdWdoIHRoZSBhbmNlc3RvcnMgb2YgdGhlIGN1cnJlbnQgbGluayB1bnRpbCB3ZSBoaXQgLmpzLW5hdi1tZW51LlxuXHRcdHdoaWxlICggLTEgPT09IHNlbGYuY2xhc3NOYW1lLmluZGV4T2YoICdqcy1uYXYtbWVudScgKSApIHtcblxuXHRcdFx0Ly8gT24gbGkgZWxlbWVudHMgdG9nZ2xlIHRoZSBjbGFzcyAuZm9jdXMuXG5cdFx0XHRpZiAoICdsaScgPT09IHNlbGYudGFnTmFtZS50b0xvd2VyQ2FzZSgpICkge1xuXHRcdFx0XHRpZiAoIC0xICE9PSBzZWxmLmNsYXNzTmFtZS5pbmRleE9mKCAnZm9jdXMnICkgKSB7XG5cdFx0XHRcdFx0c2VsZi5jbGFzc05hbWUgPSBzZWxmLmNsYXNzTmFtZS5yZXBsYWNlKCAnIGZvY3VzJywgJycgKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRzZWxmLmNsYXNzTmFtZSArPSAnIGZvY3VzJztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRzZWxmID0gc2VsZi5wYXJlbnRFbGVtZW50O1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBUb2dnbGVzIGBmb2N1c2AgY2xhc3MgdG8gYWxsb3cgc3VibWVudSBhY2Nlc3Mgb24gdGFibGV0cy5cblx0ICovXG5cdCggZnVuY3Rpb24oIGNvbnRhaW5lciApIHtcblx0XHR2YXIgdG91Y2hTdGFydEZuLCBpLFxuXHRcdFx0cGFyZW50TGluayA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCAnLm1lbnUtaXRlbS1oYXMtY2hpbGRyZW4gPiBhLCAucGFnZV9pdGVtX2hhc19jaGlsZHJlbiA+IGEnICk7XG5cblx0XHRpZiAoICdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyApIHtcblx0XHRcdHRvdWNoU3RhcnRGbiA9IGZ1bmN0aW9uKCBlICkge1xuXHRcdFx0XHR2YXIgbWVudUl0ZW0gPSB0aGlzLnBhcmVudE5vZGUsXG5cdFx0XHRcdGk7XG5cblx0XHRcdFx0aWYgKCAhIG1lbnVJdGVtLmNsYXNzTGlzdC5jb250YWlucyggJ2ZvY3VzJyApICkge1xuXHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0XHRmb3IgKCBpID0gMDsgaSA8IG1lbnVJdGVtLnBhcmVudE5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2kgKSB7XG5cdFx0XHRcdFx0XHRpZiAoIG1lbnVJdGVtID09PSBtZW51SXRlbS5wYXJlbnROb2RlLmNoaWxkcmVuW2ldICkge1xuXHRcdFx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdG1lbnVJdGVtLnBhcmVudE5vZGUuY2hpbGRyZW5baV0uY2xhc3NMaXN0LnJlbW92ZSggJ2ZvY3VzJyApO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRtZW51SXRlbS5jbGFzc0xpc3QuYWRkKCAnZm9jdXMnICk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0bWVudUl0ZW0uY2xhc3NMaXN0LnJlbW92ZSggJ2ZvY3VzJyApO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXG5cdFx0XHRmb3IgKCBpID0gMDsgaSA8IHBhcmVudExpbmsubGVuZ3RoOyArK2kgKSB7XG5cdFx0XHRcdHBhcmVudExpbmtbaV0uYWRkRXZlbnRMaXN0ZW5lciggJ3RvdWNoc3RhcnQnLCB0b3VjaFN0YXJ0Rm4sIGZhbHNlICk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9KCBjb250YWluZXIgKSApO1xufSAoKSApO1xuIl19
